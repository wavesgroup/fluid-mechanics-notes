name: build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up TeX Live
      run: |
        sudo apt update
        sudo apt install -y texlive-latex-{base,recommended,extra}

    - name: Compile LaTeX document
      run: |
        make

    - name: Upload PDF as artifact
      uses: actions/upload-artifact@v4
      with:
        name: fluid-mechanics-notes
        path: notes.pdf

    - name: Publish PDF to artifacts branch
      run: |
        set -euo pipefail
        PDF=notes.pdf
        test -f "$PDF"

        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        git fetch origin artifacts || true
        if git show-ref --verify --quiet refs/heads/artifacts; then
          :
        else
          git branch artifacts origin/artifacts 2>/dev/null || git branch artifacts
        fi

        git worktree add artifacts artifacts
        cp "$PDF" artifacts/
        cd artifacts

        if git diff --quiet -- "$PDF"; then
          echo "No PDF changes."
        else
          git add "$PDF"
          git commit -m "Update notes.pdf from ${GITHUB_SHA}"
          git push origin artifacts
        fi
